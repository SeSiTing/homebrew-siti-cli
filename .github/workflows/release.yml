name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Get tag version
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
    - name: Calculate SHA256 for GitHub archive
      id: calc_sha
      run: |
        # ä¸‹è½½ GitHub è‡ªåŠ¨ç”Ÿæˆçš„ archiveï¼ˆè¿™æ˜¯ Homebrew å®žé™…ä¼šä¸‹è½½çš„ï¼‰
        curl -sL "https://github.com/${{ github.repository }}/archive/${{ steps.get_version.outputs.tag }}.tar.gz" -o archive.tar.gz
        SHA256=$(sha256sum archive.tar.gz | cut -d' ' -f1)
        echo "sha256=$SHA256" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Archive SHA256: $SHA256"
        
    - name: Update Formula
      run: |
        # æ›´æ–° Formula/siti-cli.rb
        sed -i "s|url \".*\"|url \"https://github.com/${{ github.repository }}/archive/${{ steps.get_version.outputs.tag }}.tar.gz\"|" Formula/siti-cli.rb
        sed -i "s|sha256 \".*\"|sha256 \"${{ steps.calc_sha.outputs.sha256 }}\"|" Formula/siti-cli.rb
        
        echo "âœ… Formula å·²æ›´æ–°:"
        grep -A1 "url" Formula/siti-cli.rb | head -2
        
    - name: Commit and push Formula update
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add Formula/siti-cli.rb
        git commit -m "chore(formula): update to ${{ steps.get_version.outputs.tag }}"
        git push origin HEAD:main
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        generate_release_notes: true
        body: |
          ## å®‰è£… / æ›´æ–°
          
          ```bash
          # æ–°ç”¨æˆ·å®‰è£…
          brew tap ${{ github.repository_owner }}/siti-cli
          brew install siti-cli
          
          # å·²æœ‰ç”¨æˆ·æ›´æ–°
          brew update
          brew upgrade siti-cli
          ```
          
          ## Formula SHA256
          
          ```
          ${{ steps.calc_sha.outputs.sha256 }}
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
