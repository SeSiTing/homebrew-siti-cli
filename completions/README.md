# siti-cli 命令补全系统

## 概述

siti-cli 采用**动态补全架构**，能够自动发现和解析 `src/commands` 目录下的所有命令，无需手动维护补全列表。

## 扩展性设计

### 1. 自动发现机制
- 补全脚本会自动扫描 `src/commands` 目录
- 自动识别所有 `.sh` 文件作为可用命令
- 支持命令名的下划线/连字符转换

### 2. 元数据驱动
每个命令脚本通过注释定义补全信息：

```bash
# 描述: 命令功能描述
# 补全:
#   option1: 选项1的描述
#   option2: 选项2的描述
#   option3: 选项3的描述
# 用法:
#   siti command option1
#   siti command option2
```

### 3. 添加新命令的步骤

1. **创建命令脚本**
   ```bash
   # 在 src/commands/ 目录下创建 new_command.sh
   #!/bin/bash
   
   # 描述: 新命令的功能描述
   # 补全:
   #   subcmd1: 子命令1描述
   #   subcmd2: 子命令2描述
   # 用法:
   #   siti new-command subcmd1
   #   siti new-command subcmd2
   ```

2. **设置执行权限**
   ```bash
   chmod +x src/commands/new_command.sh
   ```

3. **补全自动生效**
   - 无需修改补全脚本
   - 补全功能会自动识别新命令
   - 支持 `siti new-command <Tab>` 补全

### 4. 补全优先级

1. **补全元数据**：优先使用 `# 补全:` 部分定义的选项
2. **用法解析**：如果没有补全元数据，从 `# 用法:` 中提取选项
3. **默认行为**：如果都没有，显示通用帮助

## 支持的功能

### Bash 补全
- 命令名补全
- 子命令补全
- 全局选项补全（--help, --version）
- 动态选项发现

### Zsh 补全
- 命令名补全（带描述）
- 子命令补全（带描述）
- 全局选项补全
- 动态选项发现
- 更好的用户体验

## 安装

补全功能通过 `setup.sh` 自动安装：

```bash
./setup.sh
```

安装完成后，重新加载 shell 配置：

```bash
source ~/.zshrc  # 或 ~/.bashrc
```

## 使用示例

```bash
# 查看所有可用命令
siti <Tab>

# 查看 proxy 命令的子选项
siti proxy <Tab>

# 补全会显示：
# on     开启终端代理
# off    关闭终端代理
# check  检查当前代理状态
# status 显示代理状态
```

## 技术实现

### Bash 补全
- 使用 `complete -F` 注册补全函数
- 动态解析命令脚本的元数据
- 支持选项和描述的提取

### Zsh 补全
- 使用 `_arguments` 和 `_describe` 函数
- 支持更丰富的补全体验
- 自动处理命令分组和描述显示

## 扩展建议

1. **复杂参数补全**：对于需要文件路径或网络地址的命令，可以扩展补全逻辑
2. **上下文感知**：根据当前目录或环境变量提供不同的补全选项
3. **缓存机制**：对于大量命令，可以考虑添加缓存机制提高性能
4. **插件系统**：支持外部插件定义自定义补全规则
